{"componentChunkName":"component---src-pages-developer-advanced-1-inventory-cd-index-mdx","path":"/developer-advanced-1/inventory-cd/","result":{"pageContext":{"frontmatter":{"title":"CD for Inventory App"},"relativePagePath":"/developer-advanced-1/inventory-cd/index.mdx","titleType":"page","MdxNode":{"id":"b8632939-a953-540e-8d46-b90b5a90df01","children":[],"parent":"5edafb92-89da-540b-b596-153841a737d7","internal":{"content":"---\ntitle: CD for Inventory App \n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\nExtending the Inventory Micro  app to include Continuous Delivery to Test. \n\n</PageDescription>\n\n## Guide\n\nThis Micro App guidance continues to build upon the microserivces that were built in the Inventory Micro App guide. Make sure you have complete [Inventory App](/developer-intermediate/inventory-app) or deployed the working [Inventory Solution](/developer-intermediate/inventory-app#deploy-the-inventory-app-solution).\n\n- we implemented the three tiers in the Inventory Mico App and deployed the app to the `dev` namespace/project.\n- We will take that app and make these additions.\n\n- Deploy the app to the `test` namespace/project using CD techniques and ArgoCD\n\n\n## Using CD to deploy to Test\n\nArgoCD is a tool that provides continuous delivery for projects and applications. If you haven't already, be sure to read\nthrough the [Continuous Delivery with ArgoCD guide](/guides/continuous-delivery).\n\nFor this exercise, we are going to use ArgoCD to push the Inventory app from `dev` to `test` (and possibly `staging` as well). If you have already completed the Inventory Micro App , then it can be used for the ArgoCD process (although perhaps with some minor pipeline updates). If you haven't completed the exercise, you can start from the [solution repositories](/developer-intermediate/inventory-app#deploy-the-inventory-app-solution) to perform the ArgoCD steps.\n\n\n### Set up the GitOps repo\n\nLet's get started with using Argo CD.\n\n- Create a new repo from the [ArgoCD <Globals name=\"template\" />](https://github.com/IBM/template-argocd-gitops/generate)\n\n- Clone the project to your machine\n\n- Create a branch named `test`\n    ```bash\n    git checkout -b test\n    ```\n\n- Push the branch to the remote\n    ```bash\n    git push -u origin test\n    ```\n\n- Create the test namespace with the CLI by running `oc sync test-{initials} --dev`\n\n### Register the GitOps repo in ArgoCD\n\nNow that the repository has been created, we need to tell ArgoCD where it is.\n\n- Get the ArgoCD login information from the `oc credentials` cli command\n\n    <InlineNotification>\n        Note: You need to be logged into the cluster on the command-line for the CLI to access the cluster information.\n    </InlineNotification>\n\n- Log into ArgoCD (use `oc credentials` to obtain your credentials and login to argo)\n\n- Click on the gear icon on the left menu to access the Settings options\n\n    ![ArgoCD config](/images/argocd-config.png)\n\n- Select the `Repositories` option\n\n- Click either the `Connect Repo using HTTPS` or `Connect Repo using SSH` button at the top and provide the information\nfor the GitOps repo you just created.\n\n### Create a project in ArgoCD (Optional)\n\nIn ArgoCD terms, each deployable component is an `Application` and applications are grouped into `Projects`. Projects are not\nrequired for ArgoCD to be able to deploy applications but it helps to organize applications and provide some restrictions\non what can be done for applications that make up a project.\n\nTo create a project, do the following:\n\n- Log into ArgoCD\n\n- Click on the gear icon on the left menu to access the Settings options\n\n    ![ArgoCD config](/images/argocd-config.png)\n\n- Select the `Projects` option\n\n- Click the `New Project` button at the top of the page.\n\n- Provide the following values then press `Create`:\n\n    - `name` - the name for the project (provide `inventory-management)\n    - `description` - a brief description of the project\n    - `sources` - click `add source` and pick the Git repository from the list that was added previously\n    - `destinations`\n        - Add `https://kubernetes.default.svc` for the cluster url and `test-{initials}` for the namespace\n        - Add `https://kubernetes.default.svc` for the cluster url and `staging-{initials}` for the namespace\n\n    **Note:** Initially, the only cluster that is available is the one in which ArgoCD is -\n    `https://kubernetes.default.svc`. By adding the two destinations we have allowed the project to be deployed\n    to both the `test-{initials}` and `staging-{initials}` namespaces within the current cluster.\n\n### Configure the GitOps repo for Inventory Management service\n\n- Copy the `app-artifactory` folder and give it a name that matches the Inventory Management service component\n(e.g. `inventory-management-svc-{initials}`)\n\n- Update `inventory-management-svc-{initials}/Chart.yaml` and update the name to match the directory name\n\n- Update `inventory-management-svc-{initials}/requirements.yaml` with the following values:\n\n    - `name` - the name of helm chart/image. This should match the folder name\n    - `version` - the version number of the helm chart\n    - `repository` - the url to the helm repository including the folder where helm charts are being stored.\n\n- here is an example\n    ```yaml\n    dependencies:\n    - name: inventory-management-svc-mjp\n      version: 1.0.0-1\n      repository: http://artifactory.mooc-one-rhos-cluster.us-east.containers.appdomain.cloud/artifactory/generic-local/mooc-team-one/\n    ```\n- The url of the Artifactory helm repository can be taken from the below step.\n\n\n- In the Artifactory Setup screen, in Set Me Up Section, select the tool as \"Generic\" and repository as \"generic-local\".Copy the deploy URL from the Set Me Up dialog box. That is the Artifactory helm repository URL. \n          ![ArtifactoryURLSetup config](/images/artifactoryurlsetup.png)\n\n- Run `kubectl get configmap/ibmcloud-config -n tools -o yaml` to print the configuration information\nfor the cluster\n\n- In `inventory-management-svc-{initials}/values.yaml` replace `<app-chart-name>` with the directory name. Replace `ingressSubdomain` with the value from the previous step. Update `tlsSecretName` with the value from the previous step. The result should look something like the following\n    ```yaml path=inventory-management-svc-{initials}/values.yaml\n    global:\n      ingressSubdomain: sms-test.us-south.containers.appdomain.cloud\n      tlsSecretName: sms-test-cluster\n\n    inventory-management-svc-{initials}:\n      replicaCount: 1\n\n      ingress:\n        enabled: true\n        tlsSecretName: sms-test-cluster\n    ```\n\n- Commit and push the changes\n    ```bash\n    git add .\n    git commit -m \"Adds inventory-management-svc config\"\n    git push\n    ```\n\n### Add an application in ArgoCD for the Inventory Management service\n\nThe last step in the process is to define the application(s) within ArgoCD that should be managed. This consists of\nconnecting the config within the Git repo to the cluster and namespace.\n\n- Log into ArgoCD\n\n- Click `New Application` and provide the following values:\n\n    - `application name` - `test-inventory-management-svc`\n    - `project` - `inventory-management`\n    - `sync-policy` - `Automatic`\n    - `repository url` - The Git url where the configuration is stored\n    - `revision` - `test`\n    - `path` - `inventory-management-svc-{initials}`\n    - `destination cluster` - The cluster url for the deployment\n    - `destination namespace` - `test-{initials}`\n    - `values file` - `values.yaml`\n\n- Click `Create`\n\n- Click on the newly created application. A graph of kubernetes resources should be shown\nif everything is configured correctly.\n\n### Make a change in the GitOps repo\n\nIn order to trigger a (re-)deployment we can make an update to a value in the GitOps repo and\nwatch ArgoCD apply the change.\n\n- Open a terminal and navigate to your GitOps repo directory\n\n- Be sure that you are in the `test` branch\n    ```bash\n    git checkout test\n    ```\n\n- Update `inventory-management-svc-{initials}/values.yaml` to increase the replica count\n    ```yaml path=inventory-management-svc-{initials}/values.yaml\n    global:\n      ingressSubdomain: sms-test.us-south.containers.appdomain.cloud\n      tlsSecretName: sms-test-cluster\n\n    inventory-management-svc-{initials}:\n      replicaCount: 3\n\n      ingress:\n        enabled: true\n        tlsSecretName: sms-test-cluster\n    ```\n\n- Commit and push the change\n    ```bash\n    git add .\n    git commit -m \"Increases replica count\"\n    ```\n\n- Log into the ArgoCD UI and look at the state of the application. It should say `Synchronizing`.\nIf you don't want to wait you can manually by pressing the `Synchronize` button.\n\n### Patch The Helm Repository URL\n\nPatch Helm repository URL to `argocd-cm` configmap in `tools` namespace.\n\n\n- Log into the cluster on the command-line.\n\n- Change the directory to the root of the ArgoCD <Globals name=\"template\" /> repo that was cloned previously.\n\n- Execute the below `addhelmrepository.sh` file with paramter of Helm repository url.\n\n    ```bash\n    ./config/addhelmrepository.sh {HELM REPO URL}\n    ``` \n\n### Hook the CI pipeline to the CD pipeline\n\nThe last stage in the CI pipeline updates the version number in the `requirements.yaml` to the version of the helm chart\nthat was just built. Through a couple naming conventions the only thing the pipeline needs in order to interact\nwith the CD process is a kubernetes secret named `gitops-cd-secret` that provides the details needed\nto connect to the git repo to push updates.\n\nThe [IGC CLI](/getting-started/cli) has a command that provides a helper to make the creating of a kubernetes secret\nwith git credentials very easy.\n\n- Log into the cluster on the command-line.\n\n- Change the directory to the root of the ArgoCD <Globals name=\"template\" /> repo that was cloned previously.\n\n- Run `igc git-secret gitops-repo -n dev-{initials}` to create the secret. This command will prompt for the username,\npersonal access token, and the branch to put in the secret.\n\n### What just happened?\n\n-  The `git-secret` command creates a secret in a kubernetes namespace containing the url, username, password, and branch information for a git repo. In the command above, we provided `gitops-cd-secret` for the secret name. (If that value is left off the secret name defaults to `{git org}.{git repo}`.). It creates a secret `git-credentials` and configmap `gitops-repo` You can verify the secret was created by running:\n   \n    ```bash\n    oc get configmap/gitops-repo -n dev-{initials}-o yaml\n    ``` \n\n**Note:**\n- For the secret to be available to the CI pipeline, the secret needs to be created in the same namespace\nwhere the pipeline is running (e.g. `dev-{initials}`).\n- The value provided for `branch` is the one the pipeline will use to when committing changes to trigger\nthe CD pipeline. `test` is the recommended value for the branch field.\n\n- Trigger the pipeline for the Inventory Management service to build by making a change\nto the Inventory Management Service code and push the changes to Git.\n\n### Repeat for BFF and UI components\n\nStarting from [Configure the GitOps repo for Inventory Management service](#Configure-the-gitops-repo-for-inventory-management-service),\nthe steps need to be repeated for each application within the project.\n","type":"Mdx","contentDigest":"8bb99ae17cbcf6e0fbd159247805359d","owner":"gatsby-plugin-mdx","counter":930},"frontmatter":{"title":"CD for Inventory App"},"exports":{},"rawBody":"---\ntitle: CD for Inventory App \n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\nExtending the Inventory Micro  app to include Continuous Delivery to Test. \n\n</PageDescription>\n\n## Guide\n\nThis Micro App guidance continues to build upon the microserivces that were built in the Inventory Micro App guide. Make sure you have complete [Inventory App](/developer-intermediate/inventory-app) or deployed the working [Inventory Solution](/developer-intermediate/inventory-app#deploy-the-inventory-app-solution).\n\n- we implemented the three tiers in the Inventory Mico App and deployed the app to the `dev` namespace/project.\n- We will take that app and make these additions.\n\n- Deploy the app to the `test` namespace/project using CD techniques and ArgoCD\n\n\n## Using CD to deploy to Test\n\nArgoCD is a tool that provides continuous delivery for projects and applications. If you haven't already, be sure to read\nthrough the [Continuous Delivery with ArgoCD guide](/guides/continuous-delivery).\n\nFor this exercise, we are going to use ArgoCD to push the Inventory app from `dev` to `test` (and possibly `staging` as well). If you have already completed the Inventory Micro App , then it can be used for the ArgoCD process (although perhaps with some minor pipeline updates). If you haven't completed the exercise, you can start from the [solution repositories](/developer-intermediate/inventory-app#deploy-the-inventory-app-solution) to perform the ArgoCD steps.\n\n\n### Set up the GitOps repo\n\nLet's get started with using Argo CD.\n\n- Create a new repo from the [ArgoCD <Globals name=\"template\" />](https://github.com/IBM/template-argocd-gitops/generate)\n\n- Clone the project to your machine\n\n- Create a branch named `test`\n    ```bash\n    git checkout -b test\n    ```\n\n- Push the branch to the remote\n    ```bash\n    git push -u origin test\n    ```\n\n- Create the test namespace with the CLI by running `oc sync test-{initials} --dev`\n\n### Register the GitOps repo in ArgoCD\n\nNow that the repository has been created, we need to tell ArgoCD where it is.\n\n- Get the ArgoCD login information from the `oc credentials` cli command\n\n    <InlineNotification>\n        Note: You need to be logged into the cluster on the command-line for the CLI to access the cluster information.\n    </InlineNotification>\n\n- Log into ArgoCD (use `oc credentials` to obtain your credentials and login to argo)\n\n- Click on the gear icon on the left menu to access the Settings options\n\n    ![ArgoCD config](/images/argocd-config.png)\n\n- Select the `Repositories` option\n\n- Click either the `Connect Repo using HTTPS` or `Connect Repo using SSH` button at the top and provide the information\nfor the GitOps repo you just created.\n\n### Create a project in ArgoCD (Optional)\n\nIn ArgoCD terms, each deployable component is an `Application` and applications are grouped into `Projects`. Projects are not\nrequired for ArgoCD to be able to deploy applications but it helps to organize applications and provide some restrictions\non what can be done for applications that make up a project.\n\nTo create a project, do the following:\n\n- Log into ArgoCD\n\n- Click on the gear icon on the left menu to access the Settings options\n\n    ![ArgoCD config](/images/argocd-config.png)\n\n- Select the `Projects` option\n\n- Click the `New Project` button at the top of the page.\n\n- Provide the following values then press `Create`:\n\n    - `name` - the name for the project (provide `inventory-management)\n    - `description` - a brief description of the project\n    - `sources` - click `add source` and pick the Git repository from the list that was added previously\n    - `destinations`\n        - Add `https://kubernetes.default.svc` for the cluster url and `test-{initials}` for the namespace\n        - Add `https://kubernetes.default.svc` for the cluster url and `staging-{initials}` for the namespace\n\n    **Note:** Initially, the only cluster that is available is the one in which ArgoCD is -\n    `https://kubernetes.default.svc`. By adding the two destinations we have allowed the project to be deployed\n    to both the `test-{initials}` and `staging-{initials}` namespaces within the current cluster.\n\n### Configure the GitOps repo for Inventory Management service\n\n- Copy the `app-artifactory` folder and give it a name that matches the Inventory Management service component\n(e.g. `inventory-management-svc-{initials}`)\n\n- Update `inventory-management-svc-{initials}/Chart.yaml` and update the name to match the directory name\n\n- Update `inventory-management-svc-{initials}/requirements.yaml` with the following values:\n\n    - `name` - the name of helm chart/image. This should match the folder name\n    - `version` - the version number of the helm chart\n    - `repository` - the url to the helm repository including the folder where helm charts are being stored.\n\n- here is an example\n    ```yaml\n    dependencies:\n    - name: inventory-management-svc-mjp\n      version: 1.0.0-1\n      repository: http://artifactory.mooc-one-rhos-cluster.us-east.containers.appdomain.cloud/artifactory/generic-local/mooc-team-one/\n    ```\n- The url of the Artifactory helm repository can be taken from the below step.\n\n\n- In the Artifactory Setup screen, in Set Me Up Section, select the tool as \"Generic\" and repository as \"generic-local\".Copy the deploy URL from the Set Me Up dialog box. That is the Artifactory helm repository URL. \n          ![ArtifactoryURLSetup config](/images/artifactoryurlsetup.png)\n\n- Run `kubectl get configmap/ibmcloud-config -n tools -o yaml` to print the configuration information\nfor the cluster\n\n- In `inventory-management-svc-{initials}/values.yaml` replace `<app-chart-name>` with the directory name. Replace `ingressSubdomain` with the value from the previous step. Update `tlsSecretName` with the value from the previous step. The result should look something like the following\n    ```yaml path=inventory-management-svc-{initials}/values.yaml\n    global:\n      ingressSubdomain: sms-test.us-south.containers.appdomain.cloud\n      tlsSecretName: sms-test-cluster\n\n    inventory-management-svc-{initials}:\n      replicaCount: 1\n\n      ingress:\n        enabled: true\n        tlsSecretName: sms-test-cluster\n    ```\n\n- Commit and push the changes\n    ```bash\n    git add .\n    git commit -m \"Adds inventory-management-svc config\"\n    git push\n    ```\n\n### Add an application in ArgoCD for the Inventory Management service\n\nThe last step in the process is to define the application(s) within ArgoCD that should be managed. This consists of\nconnecting the config within the Git repo to the cluster and namespace.\n\n- Log into ArgoCD\n\n- Click `New Application` and provide the following values:\n\n    - `application name` - `test-inventory-management-svc`\n    - `project` - `inventory-management`\n    - `sync-policy` - `Automatic`\n    - `repository url` - The Git url where the configuration is stored\n    - `revision` - `test`\n    - `path` - `inventory-management-svc-{initials}`\n    - `destination cluster` - The cluster url for the deployment\n    - `destination namespace` - `test-{initials}`\n    - `values file` - `values.yaml`\n\n- Click `Create`\n\n- Click on the newly created application. A graph of kubernetes resources should be shown\nif everything is configured correctly.\n\n### Make a change in the GitOps repo\n\nIn order to trigger a (re-)deployment we can make an update to a value in the GitOps repo and\nwatch ArgoCD apply the change.\n\n- Open a terminal and navigate to your GitOps repo directory\n\n- Be sure that you are in the `test` branch\n    ```bash\n    git checkout test\n    ```\n\n- Update `inventory-management-svc-{initials}/values.yaml` to increase the replica count\n    ```yaml path=inventory-management-svc-{initials}/values.yaml\n    global:\n      ingressSubdomain: sms-test.us-south.containers.appdomain.cloud\n      tlsSecretName: sms-test-cluster\n\n    inventory-management-svc-{initials}:\n      replicaCount: 3\n\n      ingress:\n        enabled: true\n        tlsSecretName: sms-test-cluster\n    ```\n\n- Commit and push the change\n    ```bash\n    git add .\n    git commit -m \"Increases replica count\"\n    ```\n\n- Log into the ArgoCD UI and look at the state of the application. It should say `Synchronizing`.\nIf you don't want to wait you can manually by pressing the `Synchronize` button.\n\n### Patch The Helm Repository URL\n\nPatch Helm repository URL to `argocd-cm` configmap in `tools` namespace.\n\n\n- Log into the cluster on the command-line.\n\n- Change the directory to the root of the ArgoCD <Globals name=\"template\" /> repo that was cloned previously.\n\n- Execute the below `addhelmrepository.sh` file with paramter of Helm repository url.\n\n    ```bash\n    ./config/addhelmrepository.sh {HELM REPO URL}\n    ``` \n\n### Hook the CI pipeline to the CD pipeline\n\nThe last stage in the CI pipeline updates the version number in the `requirements.yaml` to the version of the helm chart\nthat was just built. Through a couple naming conventions the only thing the pipeline needs in order to interact\nwith the CD process is a kubernetes secret named `gitops-cd-secret` that provides the details needed\nto connect to the git repo to push updates.\n\nThe [IGC CLI](/getting-started/cli) has a command that provides a helper to make the creating of a kubernetes secret\nwith git credentials very easy.\n\n- Log into the cluster on the command-line.\n\n- Change the directory to the root of the ArgoCD <Globals name=\"template\" /> repo that was cloned previously.\n\n- Run `igc git-secret gitops-repo -n dev-{initials}` to create the secret. This command will prompt for the username,\npersonal access token, and the branch to put in the secret.\n\n### What just happened?\n\n-  The `git-secret` command creates a secret in a kubernetes namespace containing the url, username, password, and branch information for a git repo. In the command above, we provided `gitops-cd-secret` for the secret name. (If that value is left off the secret name defaults to `{git org}.{git repo}`.). It creates a secret `git-credentials` and configmap `gitops-repo` You can verify the secret was created by running:\n   \n    ```bash\n    oc get configmap/gitops-repo -n dev-{initials}-o yaml\n    ``` \n\n**Note:**\n- For the secret to be available to the CI pipeline, the secret needs to be created in the same namespace\nwhere the pipeline is running (e.g. `dev-{initials}`).\n- The value provided for `branch` is the one the pipeline will use to when committing changes to trigger\nthe CD pipeline. `test` is the recommended value for the branch field.\n\n- Trigger the pipeline for the Inventory Management service to build by making a change\nto the Inventory Management Service code and push the changes to Git.\n\n### Repeat for BFF and UI components\n\nStarting from [Configure the GitOps repo for Inventory Management service](#Configure-the-gitops-repo-for-inventory-management-service),\nthe steps need to be repeated for each application within the project.\n","fileAbsolutePath":"/workspace/ibm-gsi-cloudnative-journey/src/pages/developer-advanced-1/inventory-cd/index.mdx"}}},"staticQueryHashes":["1054721580","1054721580","1364590287","2102389209","2102389209","2456312558","2746626797","2746626797","3018647132","3018647132","3037994772","3037994772","3273249464","768070550"]}